generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Auth & Multi-Tenancy
model ServiceCenter {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  address     String?
  city        String?
  state       String?
  phone       String?
  email       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  customers   Customer[] @relation("LastServiceCenter")
  jobCards    JobCard[]
  inventory   Inventory[]
  partsIssues PartsIssue[]
  appointments Appointment[]
  invoices     Invoice[]
  quotations   Quotation[]
}

model User {
  id               String         @id @default(uuid())
  email            String         @unique
  password         String
  name             String
  role             UserRole       @default(service_engineer)
  serviceCenterId  String?
  serviceCenter    ServiceCenter? @relation(fields: [serviceCenterId], references: [id], onDelete: SetNull)
  phone            String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  jobCards         JobCard[]      @relation("AssignedEngineer")
  requestedIssues  PartsIssue[]   @relation("RequestedBy")

  @@index([serviceCenterId])
}

enum UserRole {
  admin
  sc_manager
  service_engineer
  service_advisor
  call_center
  inventory_manager
  central_inventory_manager
}

// Customer
model Customer {
  id                  String    @id @default(uuid())
  customerNumber      String    @unique
  name                String
  phone               String
  whatsappNumber      String?
  alternateNumber     String?
  email               String?
  address             String?
  cityState           String?
  pincode             String?
  customerType        String?   @default("B2C")
  lastServiceCenterId String?
  lastServiceCenter   ServiceCenter? @relation("LastServiceCenter", fields: [lastServiceCenterId], references: [id])
  lastServiceDate     DateTime?
  lastInvoiceNumber   String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  deletedAt           DateTime?
  
  vehicles      Vehicle[]
  appointments  Appointment[]
  jobCards      JobCard[]
  quotations    Quotation[]
  invoices      Invoice[]
  
  @@index([phone])
  @@index([customerNumber])
}

// Vehicle
model Vehicle {
  id                   String    @id @default(uuid())
  customerId           String
  customer             Customer  @relation(fields: [customerId], references: [id])
  registration         String    @unique
  vin                  String    @unique
  vehicleMake          String
  vehicleModel         String
  vehicleYear          Int
  variant              String?
  vehicleColor         String?
  motorNumber          String?
  chargerSerialNumber  String?
  purchaseDate         DateTime?
  warrantyStatus       String?
  insuranceStartDate   DateTime?
  insuranceEndDate     DateTime?
  insuranceCompanyName String?
  currentStatus        VehicleStatus @default(AVAILABLE)
  activeJobCardId      String?
  lastServiceDate      DateTime?
  lastServiceCenterId  String?
  nextServiceDate      DateTime?
  totalServices        Int       @default(0)
  totalSpent           Decimal   @default(0)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  
  appointments  Appointment[]
  jobCards      JobCard[]
  quotations    Quotation[]
  invoices      Invoice[]

  @@index([customerId])
  @@index([registration])
  @@index([vin])
}

enum VehicleStatus {
  AVAILABLE
  ACTIVE_JOB_CARD
}

// Appointment
model Appointment {
  id                 String            @id @default(uuid())
  appointmentNumber  String            @unique
  customerId         String
  customer           Customer          @relation(fields: [customerId], references: [id])
  vehicleId          String
  vehicle            Vehicle           @relation(fields: [vehicleId], references: [id])
  serviceCenterId    String
  serviceCenter      ServiceCenter     @relation(fields: [serviceCenterId], references: [id])
  serviceType        String
  appointmentDate    DateTime
  appointmentTime    String
  customerComplaint  String?
  location           AppointmentLocation @default(STATION)
  estimatedCost      Decimal?
  status             AppointmentStatus   @default(PENDING)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  jobCards           JobCard[]

  @@index([serviceCenterId])
  @@index([customerId])
  @@index([vehicleId])
}

enum AppointmentLocation {
  STATION
  HOME
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// JobCard
model JobCard {
  id                 String        @id @default(uuid())
  jobCardNumber      String        @unique
  serviceCenterId    String
  serviceCenter      ServiceCenter @relation(fields: [serviceCenterId], references: [id])
  customerId         String
  customer           Customer      @relation(fields: [customerId], references: [id])
  vehicleId          String
  vehicle            Vehicle       @relation(fields: [vehicleId], references: [id])
  assignedEngineerId String?
  assignedEngineer   User?         @relation("AssignedEngineer", fields: [assignedEngineerId], references: [id])
  appointmentId      String?
  appointment        Appointment?  @relation(fields: [appointmentId], references: [id])
  status             JobCardStatus @default(CREATED)
  priority           JobCardPriority @default(MEDIUM)
  location           AppointmentLocation @default(STATION)
  serviceType        String
  estimatedCost      Decimal?
  part1Data          Json?         // Historical snapshot
  part2AData         Json?         // Warranty case data
  part3Data          Json?         // Requisition data
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  
  items         JobCardItem[]
  partsRequests PartsRequest[]
  invoices      Invoice[]
  
  @@index([serviceCenterId, status, createdAt])
  @@index([customerId, createdAt])
  @@index([vehicleId, createdAt])
}

enum JobCardStatus {
  CREATED
  ASSIGNED
  IN_PROGRESS
  PARTS_PENDING
  COMPLETED
  INVOICED
}

enum JobCardPriority {
  HIGH
  MEDIUM
  LOW
}

// JobCardItem
model JobCardItem {
  id              String   @id @default(uuid())
  jobCardId       String
  jobCard         JobCard  @relation(fields: [jobCardId], references: [id])
  srNo            Int
  partWarrantyTag Boolean  @default(false)
  partName        String
  partCode        String
  qty             Int
  amount          Decimal
  technician      String?
  labourCode      String?
  itemType        String   // "part" | "work_item"
  serialNumber    String?
  isWarranty      Boolean  @default(false)
  
  @@index([jobCardId])
}

// Parts Request
model PartsRequest {
  id              String             @id @default(uuid())
  jobCardId       String
  jobCard         JobCard            @relation(fields: [jobCardId], references: [id])
  status          PartsRequestStatus @default(PENDING)
  urgency         JobCardPriority    @default(MEDIUM)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  items           PartsRequestItem[]

  @@index([jobCardId])
}

enum PartsRequestStatus {
  PENDING
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
  COMPLETED
}

model PartsRequestItem {
  id              String       @id @default(uuid())
  requestId       String
  request         PartsRequest @relation(fields: [requestId], references: [id])
  inventoryPartId String
  requestedQty    Int
  approvedQty     Int          @default(0)
  isWarranty      Boolean      @default(false)

  @@index([requestId])
}

// Inventory (Service Center)
model Inventory {
  id              String   @id @default(uuid())
  serviceCenterId String
  serviceCenter   ServiceCenter @relation(fields: [serviceCenterId], references: [id])
  partName        String
  partNumber      String
  category        String
  unitPrice       Decimal
  costPrice       Decimal
  gstRate         Int
  stockQuantity   Int
  minStockLevel   Int
  maxStockLevel   Int
  location        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([serviceCenterId, stockQuantity])
  @@index([partNumber])
}

// Central Inventory
model CentralInventory {
  id            String   @id @default(uuid())
  partName      String
  partNumber    String   @unique
  category      String
  unitPrice     Decimal
  costPrice     Decimal
  gstRate       Int
  stockQuantity Int
  allocated     Int      @default(0)  // In pending issues
  available     Int      // Computed in logic
  minStockLevel Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([partNumber])
}

// Supplier
model Supplier {
  id            String   @id @default(uuid())
  name          String
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  purchaseOrders PurchaseOrder[]
}

// Purchase Order
model PurchaseOrder {
  id                    String   @id @default(uuid())
  poNumber              String   @unique
  supplierId            String
  supplier              Supplier @relation(fields: [supplierId], references: [id])
  status                POStatus @default(DRAFT)
  orderDate             DateTime
  expectedDeliveryDate  DateTime?
  receivedDate          DateTime?
  subtotal              Decimal
  cgst                  Decimal
  sgst                  Decimal
  totalAmount           Decimal
  paymentTerms          String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  items POItem[]
  
  @@index([status])
}

enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  RECEIVED
  PARTIALLY_RECEIVED
  COMPLETED
  CANCELLED
}

model POItem {
  id                     String        @id @default(uuid())
  purchaseOrderId       String
  purchaseOrder         PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  centralInventoryPartId String
  quantity               Int
  receivedQty            Int           @default(0)
  unitPrice              Decimal
  gstRate                Int

  @@index([purchaseOrderId])
}

// Parts Issue (Central â†’ SC)
model PartsIssue {
  id                  String    @id @default(uuid())
  issueNumber         String    @unique
  toServiceCenterId   String
  toServiceCenter     ServiceCenter @relation(fields: [toServiceCenterId], references: [id])
  requestedById       String
  requestedBy         User      @relation("RequestedBy", fields: [requestedById], references: [id])
  status              IssueStatus @default(PENDING_APPROVAL)
  priority            JobCardPriority @default(MEDIUM)
  dispatchedDate      DateTime?
  receivedDate        DateTime?
  transportDetails    Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  items PartsIssueItem[]
  
  @@index([toServiceCenterId])
  @@index([status])
}

enum IssueStatus {
  PENDING_APPROVAL
  APPROVED
  DISPATCHED
  COMPLETED
  REJECTED
}

model PartsIssueItem {
  id                     String     @id @default(uuid())
  issueId                String
  issue                  PartsIssue @relation(fields: [issueId], references: [id])
  centralInventoryPartId String
  requestedQty           Int
  approvedQty            Int        @default(0)
  receivedQty            Int        @default(0)

  @@index([issueId])
}

// Quotation
model Quotation {
  id                String   @id @default(uuid())
  quotationNumber   String   @unique
  serviceCenterId   String
  serviceCenter     ServiceCenter @relation(fields: [serviceCenterId], references: [id])
  customerId        String
  customer          Customer @relation(fields: [customerId], references: [id])
  vehicleId         String
  vehicle           Vehicle  @relation(fields: [vehicleId], references: [id])
  appointmentId     String?
  status            QuotationStatus @default(DRAFT)
  subtotal          Decimal
  cgst              Decimal
  sgst              Decimal
  totalAmount       Decimal
  discount          Decimal @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  items             QuotationItem[]

  @@index([serviceCenterId])
}

enum QuotationStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
}

model QuotationItem {
  id          String    @id @default(uuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id])
  partName    String
  partNumber  String?
  quantity    Int
  rate        Decimal
  gstPercent  Int

  @@index([quotationId])
}

// Invoice
model Invoice {
  id               String   @id @default(uuid())
  invoiceNumber    String   @unique
  serviceCenterId  String
  serviceCenter    ServiceCenter @relation(fields: [serviceCenterId], references: [id])
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id])
  vehicleId        String
  vehicle          Vehicle  @relation(fields: [vehicleId], references: [id])
  jobCardId        String?
  jobCard          JobCard? @relation(fields: [jobCardId], references: [id])
  status           InvoiceStatus @default(UNPAID)
  subtotal         Decimal
  cgst             Decimal
  sgst             Decimal
  grandTotal       Decimal
  placeOfSupply    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  items            InvoiceItem[]

  @@index([serviceCenterId])
  @@index([jobCardId])
}

enum InvoiceStatus {
  UNPAID
  PAID
  CANCELLED
}

model InvoiceItem {
  id         String   @id @default(uuid())
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id])
  name       String
  hsnSacCode String?
  unitPrice  Decimal
  quantity   Int
  gstRate    Int

  @@index([invoiceId])
}

// Files
model File {
  id                String   @id @default(uuid())
  url               String
  filename          String
  category          String
  relatedEntityId   String
  relatedEntityType String
  createdAt         DateTime @default(now())
}
